cat("\n===== 9 Hinge Models  Sorted by AIC =====\n")
crit_df_aic <- crit_df %>% arrange(AIC)
print(crit_df_aic)
cat("\nBest Hinge Model by AIC:\n")
print(crit_df_aic[1, ])
cat("\n===== 9 Hinge Models  Sorted by BIC =====\n")
crit_df_bic <- crit_df %>% arrange(BIC)
print(crit_df_bic)
cat("\nBest Hinge Model by BIC:\n")
print(crit_df_bic[1, ])
write.csv(crit_df, "../results/tables/01_hinge_model_table.csv", row.names = FALSE)
xt <- xtable(crit_df[order(crit_df$AIC), ])
print(xt, include.rownames = FALSE)
## ------------------------------------------------------------
## Select best hinge model (lower = 6, upper = 7.5)
## ------------------------------------------------------------
best_hinge <- fit_hinge(6, 7.5)
## ------------------------------------------------------------
## Fit natural spline models (df = 3, 4, 5, 6)
## ------------------------------------------------------------
dfs <- c(3, 4, 5, 6)
spline_models <- vector("list", length(dfs))
for (i in seq_along(dfs)) {
fml_spline <- as.formula(
paste0(
"CMR ~ ns(PM2.5, df = ", dfs[i], ") +",
"  civil_unemploy +",
"  median_HH_inc +",
"  femaleHH_ns_pct +",
"  vacant_HHunit +",
"  owner_occ_pct +",
"  eduattain_HS +",
"  pctfam_pover +",
"  population"
)
)
spline_models[[i]] <- lm(fml_spline, data = data)
}
names(spline_models) <- paste0("spline_df_", dfs)
## ------------------------------------------------------------
## Combine hinge + spline models for comparison
## ------------------------------------------------------------
all_models <- c(list(hinge_6_7.5 = best_hinge), spline_models)
## ------------------------------------------------------------
## Compare AIC/BIC across models
## ------------------------------------------------------------
aic_vals <- sapply(all_models, AIC)
bic_vals <- sapply(all_models, BIC)
crit_df2 <- data.frame(
model = names(all_models),
AIC = round(aic_vals, 2),
BIC = round(bic_vals, 2)
)
cat("\n==============================\n")
cat(" Compare Best Hinge vs Splines\n")
cat("==============================\n")
crit_df2_aic <- crit_df2 %>% arrange(AIC)
print(crit_df2_aic)
write.csv(crit_df2_aic, "../results/tables/02_hinge_vs_spline_model_table.csv", row.names = FALSE)
xt <- xtable(crit_df2_aic[order(crit_df2_aic$AIC), ])
print(xt, include.rownames = FALSE)
## Plot residuals for best hinge model
plot(best_hinge, which = 1)
## Fit model consistent with previous baseline (fit0)
fit0 <- lm(
CMR ~ PM2.5 +
I(pmax(PM2.5 - 6, 0)^2) +
I(pmax(PM2.5 - 7.5, 0)^2) +
civil_unemploy +
median_HH_inc +
femaleHH_ns_pct +
vacant_HHunit +
owner_occ_pct +
eduattain_HS +
pctfam_pover +
population,
data = data
)
par(mfrow = c(2, 2))
plot(fit0)
par(mfrow = c(1, 1))
## ============================================================
## LASSO for covariate selection (exposure terms unpenalized)
## ============================================================
## Build design matrix and response vector
X <- model.matrix(
~ PM2.5 +
I(pmax(PM2.5 - 6, 0)^2) +
I(pmax(PM2.5 - 7.5, 0)^2) +
civil_unemploy +
median_HH_inc +
femaleHH_ns_pct +
vacant_HHunit +
owner_occ_pct +
eduattain_HS +
pctfam_pover +
population,
data = data
)[, -1]
y <- data$CMR
## Set penalty factors (PM2.5 & hinge terms unpenalized)
penalty_factors <- rep(1, ncol(X))
names(penalty_factors) <- colnames(X)
exposure_cols <- c(
"PM2.5",
"I(pmax(PM2.5 - 6, 0)^2)",
"I(pmax(PM2.5 - 7.5, 0)^2)"
)
print(colnames(X))  # Check column names
penalty_factors[exposure_cols] <- 0
## Fit LASSO with cross validation
set.seed(123)
cv_fit <- cv.glmnet(
x = X,
y = y,
alpha = 1,
family = "gaussian",
penalty.factor = penalty_factors,
nfolds = 10
)
best_lambda <- cv_fit$lambda.min
cat("\nBest lambda from cv.glmnet (lambda.min):", best_lambda, "\n")
## Extract coefficients at best lambda
lasso_fit <- glmnet(
x = X,
y = y,
alpha = 1,
family = "gaussian",
lambda = best_lambda,
penalty.factor = penalty_factors
)
coef_lasso <- coef(lasso_fit)
print(coef_lasso)
## Nonzero coefficients
nonzero_idx <- which(coef_lasso != 0)
nonzero_names <- rownames(coef_lasso)[nonzero_idx]
nonzero_names <- setdiff(nonzero_names, "(Intercept)")
selected_exposure <- intersect(nonzero_names, exposure_cols)
selected_covars   <- setdiff(nonzero_names, exposure_cols)
coef_df <- data.frame(
variable = rownames(coef_lasso),
coefficient = as.numeric(coef_lasso)
)
print(coef_df)
write.csv(coef_df, "../results/tables/03_lasso_coef.csv", row.names = FALSE)
xt <- xtable(coef_df)
print(xt, include.rownames = FALSE)
cat("\nExposure terms kept by construction:\n")
print(selected_exposure)
cat("\nCovariates selected by LASSO (nonzero):\n")
print(selected_covars)
## ============================================================
## Refit model using selected covariates
## ============================================================
base_part <- "CMR ~ PM2.5 + I(pmax(PM2.5 - 6, 0)^2) + I(pmax(PM2.5 - 7.5, 0)^2)"
if (length(selected_covars) > 0) {
covar_part <- paste(selected_covars, collapse = " + ")
final_fml_char <- paste(base_part, "+", covar_part)
} else {
final_fml_char <- base_part
}
cat("\nFinal model formula based on LASSO:\n")
cat(final_fml_char, "\n")
final_formula <- as.formula(final_fml_char)
final_model <- lm(final_formula, data = data)
cat("\n==============================\n")
cat(" Final model summary (LASSO) \n")
cat("==============================\n")
summary(final_model)
cat("\nAIC(final_model) =", AIC(final_model), "\n")
cat("BIC(final_model) =", BIC(final_model), "\n")
pdf("../results/figures/04_post_LASSO_model_diagnostics.pdf", width = 8, height = 8)
par(mfrow = c(2, 2))
plot(final_model)
dev.off()
par(mfrow = c(1, 1))
vif(final_model)
vif_table <- as.data.frame(vif(final_model))
write.csv(vif_table, "../results/tables/04_vif_table.csv", row.names = TRUE)
xt <- xtable(vif_table)
print(xt)
## Moving average smoothing by PM2.5
data_clean <- data %>%
arrange(PM2.5) %>%
mutate(
CMR_MA100 = rollmean(
x     = CMR,
k     = 100,
fill  = NA,
align = "center"
)
)
## Generate PM2.5 sequence
pm_seq <- seq(
from = min(data$PM2.5, na.rm = TRUE),
to   = max(data$PM2.5, na.rm = TRUE),
length.out = 200
)
## Build new dataset for prediction using means of SES covariates
newdat <- data.frame(
PM2.5           = pm_seq,
median_HH_inc   = mean(data$median_HH_inc,   na.rm = TRUE),
femaleHH_ns_pct = mean(data$femaleHH_ns_pct, na.rm = TRUE),
owner_occ_pct   = mean(data$owner_occ_pct,   na.rm = TRUE),
eduattain_HS    = mean(data$eduattain_HS,    na.rm = TRUE),
pctfam_pover    = mean(data$pctfam_pover,    na.rm = TRUE),
population      = mean(data$population,      na.rm = TRUE)
)
## Predict from final model
newdat$CMR_pred <- predict(final_model, newdata = newdat)
## Plot prediction + moving average
p2 <- ggplot() +
geom_point(
data  = data,
aes(x = PM2.5, y = CMR),
alpha = 0.4,
color = "black"
) +
geom_line(
data  = data_clean,
aes(x = PM2.5, y = CMR_MA100),
color = "blue",
size  = 1.2,
alpha = 0.8
) +
geom_line(
data  = newdat,
aes(x = PM2.5, y = CMR_pred),
color = "red",
size  = 1.3
) +
geom_vline(
xintercept = c(6, 7.5),
linetype   = "dashed",
color      = "grey40"
) +
labs(
title = "CMR vs PM2.5 (Hinge-Squared Model with LASSO-selected Covariates)",
x     = "PM2.5 concentration",
y     = "County mortality rate (CMR)"
) +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(hjust = 0.5)
)
p2
## ============================================================
## Plot interaction effects
## ============================================================
plot_effect_modification <- function(ses_var) {
if (!ses_var %in% names(final_inter_models)) {
stop("No fitted interaction model for ", ses_var,
". Check 'final_inter_models' names.")
}
model <- final_inter_models[[ses_var]]
pm_seq <- seq(
from = min(data$PM2.5, na.rm = TRUE),
to   = max(data$PM2.5, na.rm = TRUE),
length.out = 200
)
ses_q <- quantile(data[[ses_var]], probs = c(0.1, 0.5, 0.9), na.rm = TRUE)
plot_df <- purrr::map_dfr(seq_along(ses_q), function(i) {
level <- ses_q[i]
newdat <- data.frame(PM2.5 = pm_seq)
newdat[[ses_var]] <- level
for (v in selected_covars) {
if (v != ses_var) {
newdat[[v]] <- mean(data[[v]], na.rm = TRUE)
}
}
newdat$pred <- predict(model, newdata = newdat)
newdat$SES_level <- paste0(ses_var, " = ", round(level, 2))
newdat
})
p <- ggplot(plot_df, aes(x = PM2.5, y = pred, color = SES_level)) +
geom_line(size = 1.2) +
labs(
title = paste("Effect modification of PM2.5 by", ses_var),
x = "PM2.5 concentration",
y = "Predicted CMR",
color = "SES level"
) +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(hjust = 0.5),
legend.position = c(0.95, 0.05),
legend.justification = c(1, 0),
legend.background = element_rect(
fill  = "white",
color = "grey80"
)
)
return(p)
}
## ============================================================
## Plot interaction effects
## ============================================================
plot_effect_modification <- function(ses_var) {
if (!ses_var %in% names(final_inter_models)) {
stop("No fitted interaction model for ", ses_var,
". Check 'final_inter_models' names.")
}
model <- final_inter_models[[ses_var]]
pm_seq <- seq(
from = min(data$PM2.5, na.rm = TRUE),
to   = max(data$PM2.5, na.rm = TRUE),
length.out = 200
)
ses_q <- quantile(data[[ses_var]], probs = c(0.1, 0.5, 0.9), na.rm = TRUE)
plot_df <- purrr::map_dfr(seq_along(ses_q), function(i) {
level <- ses_q[i]
newdat <- data.frame(PM2.5 = pm_seq)
newdat[[ses_var]] <- level
for (v in selected_covars) {
if (v != ses_var) {
newdat[[v]] <- mean(data[[v]], na.rm = TRUE)
}
}
newdat$pred <- predict(model, newdata = newdat)
newdat$SES_level <- paste0(ses_var, " = ", round(level, 2))
newdat
})
ggplot(plot_df, aes(x = PM2.5, y = pred, color = SES_level)) +
geom_line(size = 1.2) +
labs(
title = paste("Effect modification of PM2.5 by", ses_var),
x = "PM2.5 concentration",
y = "Predicted CMR",
color = "SES level"
) +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(hjust = 0.5),
legend.position = c(0.95, 0.05),
legend.justification = c(1, 0),
legend.background = element_rect(
fill  = "white",
color = "grey80"
)
)
}
plot_effect_modification("pctfam_pover")
plot_effect_modification("femaleHH_ns_pct")
plot_effect_modification("owner_occ_pct")
plot_effect_modification("population")
ggsave("../results/figures/06_interaction_pctfam_pover.pdf",
plot = plot_effect_modification("pctfam_pover"),
width = 7, height = 5, dpi = 300)
ggsave("../results/figures/07_interaction_femaleHH_ns_pct.pdf",
plot = plot_effect_modification("femaleHH_ns_pct"),
width = 7, height = 5, dpi = 300)
ggsave("../results/figures/08_interaction_owner_occ_pct.pdf",
plot = plot_effect_modification("owner_occ_pct"),
width = 7, height = 5, dpi = 300)
ggsave("../results/figures/09_interaction_population.pdf",
plot = plot_effect_modification("population"),
width = 7, height = 5, dpi = 300)
## ============================================================
## Final model coefficients + significance
## ============================================================
coef_mat <- summary(final_model)$coefficients
ci_mat   <- confint(final_model)
beta_table <- data.frame(
term      = rownames(coef_mat),
estimate  = coef_mat[, "Estimate"],
std_error = coef_mat[, "Std. Error"],
ci_lower  = ci_mat[, 1],
ci_upper  = ci_mat[, 2],
p_value   = coef_mat[, "Pr(>|t|)"],
significant = ifelse(coef_mat[, "Pr(>|t|)"] < 0.05, "Yes", "No"),
row.names = NULL
)
beta_table_noint <- beta_table %>%
dplyr::filter(term != "(Intercept)")
cat("\n==============================\n")
cat(" Final model coefficient table \n")
cat("==============================\n")
print(beta_table_noint)
write.csv(beta_table_noint, "../results/tables/05_beta_table_noint.csv", row.names = FALSE)
xt <- xtable(beta_table_noint)
print(xt, include.rownames = FALSE)
## ============================================================
## Interaction coefficient summary (PM2.5 × SES)
## ============================================================
library(dplyr)
library(purrr)
interaction_coef_table <- purrr::map_dfr(SES_vars, function(ses) {
fit <- interaction_results[[ses]]
sm <- summary(fit)$coefficients
ci <- confint(fit)
inter_name1 <- paste0("PM2.5:", ses)
inter_name2 <- paste0(ses, ":PM2.5")
if (inter_name1 %in% rownames(sm)) {
inter_name <- inter_name1
} else if (inter_name2 %in% rownames(sm)) {
inter_name <- inter_name2
} else {
stop("Cannot find interaction term for ", ses)
}
tibble::tibble(
SES        = ses,
term       = inter_name,
estimate   = sm[inter_name, "Estimate"],
std_error  = sm[inter_name, "Std. Error"],
ci_lower   = ci[inter_name, 1],
ci_upper   = ci[inter_name, 2],
p_value    = sm[inter_name, "Pr(>|t|)"],
significant = ifelse(sm[inter_name, "Pr(>|t|)"] < 0.05, "Yes", "No")
)
})
cat("\n=====================================\n")
cat(" Interaction coefficient table (PM2.5 × SES)\n")
cat("=====================================\n")
print(interaction_coef_table)
write.csv(interaction_coef_table, "../results/tables/07_interaction_coef_table.csv", row.names = FALSE)
xt <- xtable(interaction_coef_table)
print(xt, include.rownames = FALSE)
## ------------------------------------------------------------
## Joint test for hinge terms
## ------------------------------------------------------------
hinge1 <- "I(pmax(PM2.5 - 6, 0)^2)"
hinge2 <- "I(pmax(PM2.5 - 7.5, 0)^2)"
joint_test <- linearHypothesis(
model = final_model,
hypothesis.matrix = c(
paste0(hinge1, " = 0"),
paste0(hinge2, " = 0")
)
)
## ============================================================
## Joint hypothesis test: export CSV + LaTeX
## ============================================================
cat("\n==============================\n")
cat(" Joint hypothesis test: hinge terms = 0\n")
cat("==============================\n")
print(joint_test)
joint_df <- as.data.frame(joint_test)
joint_df <- data.frame(
Model = rownames(joint_df),
joint_df,
row.names = NULL
)
cat("\nClean joint-test table:\n")
print(joint_df)
write.csv(joint_df, "../results/tables/06_joint_hypothesis_test.csv", row.names = FALSE)
xt <- xtable(joint_df, caption = "Joint hypothesis test for hinge terms.")
print(xt, include.rownames = FALSE)
# ==============================
# Post-LASSO model: Scatter + MA100 + Model Fit
# ==============================
data_sorted <- data %>% arrange(PM2.5)
data_sorted$CMR_MA100 <- rollmean(
data_sorted$CMR,
k    = 100,
fill = NA,
align = "center"
)
data_clean <- data_sorted %>% filter(!is.na(CMR_MA100))
pm_seq <- seq(
from = min(data$PM2.5, na.rm = TRUE),
to   = max(data$PM2.5, na.rm = TRUE),
length.out = 300
)
exposure_vars <- c("PM2.5")
covar_vars <- setdiff(selected_covars, exposure_vars)
cov_means <- data %>% summarise(across(all_of(covar_vars), ~ mean(.x, na.rm = TRUE)))
newdat <- data.frame(PM2.5 = pm_seq)
if (length(covar_vars) > 0) {
for (v in covar_vars) {
newdat[[v]] <- cov_means[[v]]
}
}
newdat$CMR_pred <- predict(final_model, newdata = newdat)
p_final <- ggplot() +
geom_point(
data = data,
aes(x = PM2.5, y = CMR),
alpha = 0.4,
color = "black"
) +
geom_line(
data = data_clean,
aes(x = PM2.5, y = CMR_MA100),
color = "blue",
size = 1.2,
alpha = 0.8
) +
geom_line(
data = newdat,
aes(x = PM2.5, y = CMR_pred),
color = "red",
size = 1.3
) +
geom_vline(
xintercept = c(6, 7.5),
linetype   = "dashed",
color      = "grey40"
) +
labs(
title = "CMR vs PM2.5 (Post-LASSO Model Fit)",
x = "PM2.5 concentration",
y = "County mortality rate (CMR)"
) +
theme_minimal(base_size = 14) +
theme(plot.title = element_text(hjust = 0.5))
p_final
ggsave(
filename = "../results/figures/05_CMR_PM25_Post_LASSO.pdf",
plot     = p_final,
width    = 8,
height   = 6
)
